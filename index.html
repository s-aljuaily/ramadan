<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†ÙŠØ© (A4)</title>

  <!-- Cairo Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0d10;
      --card:#121722;
      --muted:#aab4c5;
      --text:#eef2ff;
      --line:#243045;
      --accent:#f6c454;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#07090c, #0b0d10 50%, #07090c);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:22px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; }
    }
    .card{
      background:rgba(18,23,34,.85);
      border:1px solid rgba(36,48,69,.7);
      border-radius:18px;
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    h1{
      margin:0 0 8px 0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      background:#0f1420;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-family:"Cairo", sans-serif;
      font-size:14px;
    }
    textarea{min-height:78px; resize:vertical;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
      line-height:1.5;
    }
    .btns{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid rgba(36,48,69,.9);
      background:#0f1420;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family:"Cairo", sans-serif;
      font-weight:700;
      transition:.15s;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(246,196,84,.9);}
    button.primary{
      background: linear-gradient(135deg, rgba(246,196,84,.18), rgba(246,196,84,.06));
      border-color: rgba(246,196,84,.55);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(36,48,69,.8);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      margin-bottom:10px;
    }

    /* Preview */
    .previewHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .previewHead .meta{
      color:var(--muted);
      font-size:12px;
    }
    .canvasWrap{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(36,48,69,.8);
      background:#0b0f16;
      padding:10px;
    }
    canvas{
      max-width:100%;
      height:auto;
      border-radius:10px;
    }

    .small{
      font-size:12px; color:var(--muted); margin-top:10px; line-height:1.7;
    }
    .hr{height:1px; background:rgba(36,48,69,.8); margin:14px 0;}
    .condList{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
    }
    .condItem{
      display:grid;
      grid-template-columns: 1fr 44px;
      gap:8px;
      align-items:center;
    }
    .danger{
      border-color: rgba(255, 87, 87, .6) !important;
      color: rgba(255, 190, 190, 1);
    }
  </style>
</head>
<body>

  <div class="wrap">
    <!-- Controls -->
    <div class="card">
      <h1>Ù…ÙˆÙ„Ù‘Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†ÙŠØ© (A4)</h1>
      <p class="sub">
        ØªÙƒØªØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ·Ù„Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©. Ù„Ùˆ ØªØ±ÙƒØª Ø®Ø§Ù†Ø© ÙØ§Ø¶ÙŠØ© Ø¨Ù†Ø¹Ø¨ÙŠÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù†Øµ Ø§ÙØªØ±Ø§Ø¶ÙŠ.
        Ø§Ù„ØªØµØ¯ÙŠØ±: PNG + PDF Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.
      </p>

      <div class="pill">ğŸ–¼ï¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: ØµÙˆØ±Ø© A4 Ø§Ù„Ù…ÙØ±Ù‘ØºØ©</div>

      <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ (A4)</label>
      <input id="bgUrl" value="https://i.imgur.com/vEturSp.jpeg" />

      <label style="margin-top:10px;">Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ (Ø£ÙØ¶Ù„ Ø­Ù„ Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©)</label>
      <input id="bgFile" type="file" accept="image/*" />
      <div class="hint">
        âœ… Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø§ ÙŠØ´ØªØºÙ„ Ø£Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø³Ø¨Ø¨ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªØµÙØ­ØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù‡Ù†Ø§.
        (Ù†Ø¶Ù…Ù† Ø¨Ø¹Ø¯Ù‡Ø§ Ø£Ù† PNG/PDF ÙŠØ´ØªØºÙ„ 100%).
      </div>

      <div class="row">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
          <input id="familyName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø³ÙˆÙŠÙ„Ù…" />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ø­Ø¯ 60)</label>
          <input id="contestName" maxlength="60" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ© Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ" />
        </div>
      </div>

      <label>ÙˆØµÙ/Ù…Ù‚Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="intro" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ© Ù„Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"></textarea>

      <div class="hr"></div>

      <label>Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ø§Ø®ØªØ± 4 Ù…Ø³Ø§Ø±Ø§Øª)</label>
      <div class="row">
        <div>
          <select class="track" data-i="1"></select>
          <input class="trackOther" data-i="1" placeholder="Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰) Ø§ÙƒØªØ¨ Ù‡Ù†Ø§" style="display:none;margin-top:8px;">
        </div>
        <div>
          <select class="track" data-i="2"></select>
          <input class="trackOther" data-i="2" placeholder="Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰) Ø§ÙƒØªØ¨ Ù‡Ù†Ø§" style="display:none;margin-top:8px;">
        </div>
      </div>
      <div class="row">
        <div>
          <select class="track" data-i="3"></select>
          <input class="trackOther" data-i="3" placeholder="Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰) Ø§ÙƒØªØ¨ Ù‡Ù†Ø§" style="display:none;margin-top:8px;">
        </div>
        <div>
          <select class="track" data-i="4"></select>
          <input class="trackOther" data-i="4" placeholder="Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰) Ø§ÙƒØªØ¨ Ù‡Ù†Ø§" style="display:none;margin-top:8px;">
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ³Ù…ÙŠØ¹</label>
      <div class="row">
        <div>
          <select id="tasmeeType">
            <option value="default">Ø¨Ù†Ø§Øª / Ø£ÙˆÙ„Ø§Ø¯ (ØªØ­Ø¯ÙŠØ¯ Ù…Ø´Ø±Ù)</option>
            <option value="other">Ø£Ø®Ø±Ù‰ (Ø³Ø·Ø±ÙŠÙ†)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div id="tasmeeDefault">
        <div class="row">
          <div>
            <label>ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§Øª Ø³ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯:</label>
            <input id="girlsAt" placeholder="Ù…Ø«Ø§Ù„: ÙØ§Ø·Ù…Ø©" />
          </div>
          <div>
            <label>ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯ Ø³ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯:</label>
            <input id="boysAt" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¯Ø§ÙˆØ¯" />
          </div>
        </div>
      </div>

      <div id="tasmeeOther" style="display:none;">
        <label>Ø§ÙƒØªØ¨ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø³Ø·Ø±ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</label>
        <textarea id="tasmeeOtherText" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ)\nÙˆÙŠØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­"></textarea>
      </div>

      <div class="hr"></div>

      <label>Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (2â€“4) + ØªÙ‚Ø¯Ø± ØªØ²ÙŠØ¯</label>
      <div class="condList" id="conds"></div>
      <div class="btns">
        <button id="addCond" type="button">+ Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø·</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªØ³Ù„ÙŠÙ… (Ù†Øµ)</label>
          <input id="deadline" placeholder="Ù…Ø«Ø§Ù„: 29 Ø±Ù…Ø¶Ø§Ù†" />
        </div>
        <div>
          <label>Ù…Ù„Ø­ÙˆØ¸Ø© (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ - Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="note" placeholder="Ù…Ø«Ø§Ù„: Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ÙˆØ§ Ù…Ø¹..." />
        </div>
      </div>

      <label>Ø§Ù„Ø®ØªØ§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="closing" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ© Ù„Ù„Ø®ØªØ§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ" />

      <div class="btns">
        <button class="primary" id="renderBtn" type="button">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        <button id="downloadPng" type="button">ØªØ­Ù…ÙŠÙ„ PNG</button>
        <button id="downloadPdf" type="button">ØªØ­Ù…ÙŠÙ„ PDF (A4)</button>
      </div>

      <p class="small">
        âœ… Ø­ØªÙ‰ Ù„Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ø§ Ø³Ù…Ø­ (CORS)ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ø·ÙŠÙƒ Ù‚Ø§Ù„Ø¨ Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠØ´ØªØºÙ„.
        Ù„ÙƒÙ† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ù„Ø¨ 100%: Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ.
      </p>
    </div>

    <!-- Preview -->
    <div class="card">
      <div class="previewHead">
        <div>
          <h1 style="margin:0;font-size:16px;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h1>
          <div class="meta">A4 â€¢ Cairo â€¢ RTL</div>
        </div>
        <div class="meta" id="status">Ø¬Ø§Ù‡Ø²</div>
      </div>
      <div class="canvasWrap">
        <canvas id="canvas" width="2480" height="3508"></canvas>
      </div>
    </div>
  </div>

<script>
  // ====== Config ======
  const A4_W = 2480; // ~A4 at 300dpi
  const A4_H = 3508;

  const TRACK_OPTIONS = [
    "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù","Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ","Ø³ÙˆØ±Ø© ÙŠØ³","Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ø­Ù…Ù†","Ø³ÙˆØ±Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø³ÙˆØ±Ø© Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ø³Ø§Ù†",
    "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø¨Ø£","Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø³ÙˆØ±Ø© Ø¹Ø¨Ø³","Ø³ÙˆØ±Ø© Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø³ÙˆØ±Ø© Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø·ÙÙÙŠÙ†",
    "Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø³ÙˆØ±Ø© Ø§Ù„Ø·Ø§Ø±Ù‚","Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø³ÙˆØ±Ø© Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø³ÙˆØ±Ø© Ø§Ù„ÙØ¬Ø±","Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù„Ø¯","Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ù…Ø³",
    "Ø³ÙˆØ±Ø© Ø§Ù„Ø¶Ø­Ù‰","Ø³ÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø­","Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ø¯Ø±","Ø³ÙˆØ±Ø© Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø³ÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª","Ø³ÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©",
    "Ø³ÙˆØ±Ø© Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø³ÙˆØ±Ø© Ø§Ù„Ø¹ØµØ±","Ø³ÙˆØ±Ø© Ø§Ù„Ù‡Ù…Ø²Ø©","Ø³ÙˆØ±Ø© Ø§Ù„ÙÙŠÙ„","Ø³ÙˆØ±Ø© Ù‚Ø±ÙŠØ´","Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ«Ø±",
    "Ø³ÙˆØ±Ø© Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø³ÙˆØ±Ø© Ø§Ù„Ù†ØµØ±","Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø³Ø¯","Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚","Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³",
    "Ø¬Ø²Ø¡ Ø¹Ù…","Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ",
    "Ø£Ø®Ø±Ù‰ (Ø§ÙƒØªØ¨Ù‡Ø§ Ø¨Ù†ÙØ³Ùƒ)"
  ];

  const DEFAULT_TRACKS = ["Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙ‡Ù", "Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ", "Ø¬Ø²Ø¡ Ø¹Ù…", "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³"]; // ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª

  const DEFAULT_INTRO = () =>
`âœ¨ ÙØ±ØµØ© Ø±Ø§Ø¦Ø¹Ø© Ù„Ø­ÙØ¸ ÙƒØªØ§Ø¨ Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„ÙÙˆØ² Ø¨Ø¬ÙˆØ§Ø¦Ø² Ù‚ÙŠÙ…Ø©! âœ¨\nÙŠØ³Ø±Ù‘ÙƒÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙŠ ØªÙ‡Ø¯Ù Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ù‰ Ø­ÙØ¸ ÙƒÙ„Ø§Ù… Ø§Ù„Ù„Ù‡ ÙˆØªØ¯Ø¨Ø±Ù‡.\nÙ‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„ÙŠØ³Øª ÙÙ‚Ø· Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø¯Ø±Ø§ØªØŒ Ø¨Ù„ Ù‡ÙŠ Ø£ÙŠØ¶Ù‹Ø§ Ø·Ø±ÙŠÙ‚ Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø± ÙˆØ§Ù„Ø¨Ø±ÙƒØ©.`;

  const DEFAULT_CONDS = [
    "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ØªÙ„Ø§ÙˆØ© Ø§Ù„ØµØ­ÙŠØ­Ø©.",
    "Ø§Ù„ØªØ­Ù„Ù‘ÙŠ Ø¨Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© ÙˆØ±ÙˆØ­ Ø§Ù„ØªÙ†Ø§ÙØ³ Ø§Ù„Ø·ÙŠØ¨."
  ];

  const DEFAULT_CLOSING = "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†ØŒ ÙˆØ§Ø®ØªØ± Ù…Ø³Ø§Ø±ÙƒØŒ ÙˆØ§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù…Ø¹ Ø§Ù„Ù‚Ø±Ø¢Ù†!";

  // ====== DOM ======
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const bgUrl = document.getElementById("bgUrl");
  const bgFile = document.getElementById("bgFile");

  // If user uploads a template image, we use it as a dataURL to avoid CORS issues.
  let bgDataUrl = "";

  const familyName = document.getElementById("familyName");
  const contestName = document.getElementById("contestName");
  const intro = document.getElementById("intro");

  const tasmeeType = document.getElementById("tasmeeType");
  const tasmeeDefault = document.getElementById("tasmeeDefault");
  const tasmeeOther = document.getElementById("tasmeeOther");
  const girlsAt = document.getElementById("girlsAt");
  const boysAt = document.getElementById("boysAt");
  const tasmeeOtherText = document.getElementById("tasmeeOtherText");

  const condsEl = document.getElementById("conds");
  const addCondBtn = document.getElementById("addCond");

  const deadline = document.getElementById("deadline");
  const note = document.getElementById("note");
  const closing = document.getElementById("closing");

  const statusEl = document.getElementById("status");

  const renderBtn = document.getElementById("renderBtn");
  const downloadPng = document.getElementById("downloadPng");
  const downloadPdf = document.getElementById("downloadPdf");

  // ====== Helpers ======
  function setStatus(msg){ statusEl.textContent = msg; }

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      // Only for remote URLs; dataURL/local upload does not need this.
      if(/^https?:\/\//i.test(url)) img.crossOrigin = "anonymous";
      img.onload = ()=> resolve(img);
      img.onerror = ()=> reject(new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: " + url));
      img.src = url.trim();
    });
  }

  function clampText(str, max){
    if(!str) return "";
    str = String(str).trim();
    return str.length > max ? str.slice(0, max-1) + "â€¦" : str;
  }

  function isEmpty(v){ return !v || !String(v).trim(); }

  function wrapText(ctx, text, maxWidth){
    const words = text.split(/\s+/).filter(Boolean);
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      if(ctx.measureText(test).width <= maxWidth){
        line = test;
      }else{
        if(line) lines.push(line);
        line = w;
      }
    }
    if(line) lines.push(line);
    return lines;
  }

  function drawWrapped(ctx, text, x, y, maxWidth, lineHeight, align="center"){
    ctx.textAlign = align;
    const lines = text.split("\n").flatMap(p => wrapText(ctx, p, maxWidth));
    lines.forEach((ln, i)=> ctx.fillText(ln, x, y + i*lineHeight));
    return lines.length * lineHeight;
  }

  function createCondInput(value=""){
    const wrap = document.createElement("div");
    wrap.className = "condItem";

    const input = document.createElement("input");
    input.value = value;
    input.placeholder = "Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ø±Ø· Ù‡Ù†Ø§...";
    input.addEventListener("input", ()=> render());

    const del = document.createElement("button");
    del.type="button";
    del.textContent="Ø­Ø°Ù";
    del.className="danger";
    del.addEventListener("click", ()=>{ wrap.remove(); render(); });

    wrap.appendChild(input);
    wrap.appendChild(del);
    return wrap;
  }

  function drawFallbackBackground(){
    // A printable, simple A4 template so downloads ALWAYS work.
    const g = ctx.createLinearGradient(0,0,0,A4_H);
    g.addColorStop(0, "#f7f1e6");
    g.addColorStop(1, "#efe2cd");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,A4_W,A4_H);

    // Border
    ctx.strokeStyle = "#3b2a1a";
    ctx.lineWidth = 18;
    ctx.strokeRect(120,120,A4_W-240,A4_H-240);
    ctx.lineWidth = 6;
    ctx.strokeRect(160,160,A4_W-320,A4_H-320);

    // Top ornaments
    ctx.fillStyle = "rgba(59,42,26,.12)";
    ctx.beginPath();
    ctx.roundRect(320, 260, A4_W-640, 2400, 120);
    ctx.fill();

    // Simple lantern circle
    ctx.fillStyle = "rgba(246,196,84,.35)";
    ctx.beginPath();
    ctx.arc(A4_W-420, 520, 120, 0, Math.PI*2);
    ctx.fill();

    // bottom desk bar
    ctx.fillStyle = "rgba(59,42,26,.18)";
    ctx.fillRect(0, A4_H-520, A4_W, 520);
  }

  // ====== Tracks UI ======
  function initTracks(){
    document.querySelectorAll("select.track").forEach(sel=>{
      sel.innerHTML = TRACK_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join("");
      const i = Number(sel.dataset.i);
      const def = DEFAULT_TRACKS[i-1];
      if(def && TRACK_OPTIONS.includes(def)) sel.value = def;

      sel.addEventListener("change", ()=>{
        const i = sel.dataset.i;
        const other = document.querySelector(`input.trackOther[data-i="${i}"]`);
        if(sel.value.startsWith("Ø£Ø®Ø±Ù‰")){
          other.style.display = "block";
        }else{
          other.style.display = "none";
          other.value = "";
        }
        render();
      });

      sel.addEventListener("input", render);
    });

    document.querySelectorAll("input.trackOther").forEach(inp=> inp.addEventListener("input", render));
  }

  function getTracks(){
    const out = [];
    for(let i=1;i<=4;i++){
      const sel = document.querySelector(`select.track[data-i="${i}"]`);
      const other = document.querySelector(`input.trackOther[data-i="${i}"]`);
      let val = sel?.value || "";
      if(val.startsWith("Ø£Ø®Ø±Ù‰")) val = other?.value?.trim() || "Ù…Ø³Ø§Ø± (Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰)";
      out.push(val);
    }
    return out;
  }

  // ====== Defaults generator ======
  function buildData(){
    const fam = familyName.value.trim();
    const famFinal = fam || "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©";

    const contest = clampText(contestName.value, 60);
    const contestFinal = contest || `Ù…Ø³Ø§Ø¨Ù‚Ø© ${famFinal} Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…`;

    const introFinal = isEmpty(intro.value) ? DEFAULT_INTRO() : intro.value.trim();

    const tracks = getTracks();

    const tasmeeFinal = (()=>{
      if(tasmeeType.value === "default"){
        const g = girlsAt.value.trim() || "ÙØ§Ø·Ù…Ø©";
        const b = boysAt.value.trim() || "Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¯Ø§ÙˆØ¯";
        return {
          type:"default",
          lines:[
            `ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§Øª Ø³ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯: ${g}.`,
            `ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯ Ø³ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯: ${b}.`
          ]
        };
      }
      const t = tasmeeOtherText.value.trim();
      const safe = t || "Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ³Ù…ÙŠØ¹: ØªÙØ­Ø¯Ù‘Ø¯ Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¸Ù…Ø©.";
      return { type:"other", lines: safe.split("\n").slice(0,2) };
    })();

    const conds = Array.from(condsEl.querySelectorAll("input")).map(i=> i.value.trim()).filter(Boolean);
    const condsFinal = conds.length ? conds : DEFAULT_CONDS.slice();

    return {
      bg: (bgDataUrl || bgUrl.value.trim()),
      fam: famFinal,
      contest: contestFinal,
      intro: introFinal,
      tracks,
      tasmee: tasmeeFinal,
      conds: condsFinal,
      deadline: deadline.value.trim() || "29 Ø±Ù…Ø¶Ø§Ù†",
      note: note.value.trim(),
      closing: closing.value.trim() || DEFAULT_CLOSING
    };
  }

  // ====== Draw layout on canvas ======
  async function render(){
    setStatus("ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«...");
    const data = buildData();

    ctx.clearRect(0,0,A4_W,A4_H);

    // 1) Try template image (uploaded dataURL is best)
    let img = null;
    let usedFallback = false;
    const bgToUse = data.bg;

    if(bgToUse){
      try{
        img = await loadImage(bgToUse);
      }catch(err){
        console.warn(err);
        img = null;
      }
    }

    // 2) If template fails (CORS / network), draw fallback background so export ALWAYS works
    if(img){
      ctx.drawImage(img, 0, 0, A4_W, A4_H);
    }else{
      usedFallback = true;
      drawFallbackBackground();
    }

    const titleColor = "#3b2a1a";
    const bodyColor  = "#3b2a1a";
    const accentColor = "#8a5a2a";

    const centerX = A4_W/2;
    let y = 520;

    // Family
    ctx.fillStyle = titleColor;
    ctx.font = "800 78px Cairo";
    ctx.textAlign = "center";
    ctx.fillText(data.fam, centerX, y);

    // Contest
    y += 130;
    ctx.font = "900 102px Cairo";
    const contestLines = wrapText(ctx, data.contest, 1750);
    contestLines.slice(0,2).forEach((ln, i)=> ctx.fillText(ln, centerX, y + i*110));
    y += Math.min(2, contestLines.length)*110;

    // Intro
    y += 70;
    ctx.font = "700 46px Cairo";
    ctx.fillStyle = bodyColor;
    const introHeight = drawWrapped(ctx, data.intro, centerX, y, 1750, 70, "center");
    y += introHeight + 70;

    // Tracks title
    ctx.fillStyle = accentColor;
    ctx.font = "900 70px Cairo";
    ctx.fillText("Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©", centerX, y);
    y += 78;

    ctx.fillStyle = bodyColor;
    ctx.font = "700 42px Cairo";
    ctx.fillText("(ÙŠØ®ØªØ§Ø± ÙƒÙ„ Ù…Ø´Ø§Ø±Ùƒ Ù…Ø³Ø§Ø±Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙ‚Ø·)", centerX, y);
    y += 85;

    ctx.font = "800 50px Cairo";
    const trackLines = [
      `Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ÙˆÙ„: ${data.tracks[0]}.`,
      `Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: ${data.tracks[1]}.`,
      `Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«: ${data.tracks[2]}.`,
      `Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹: ${data.tracks[3]}.`,
    ];

    trackLines.forEach((t)=>{
      const h = drawWrapped(ctx, t, centerX, y, 1750, 76, "center");
      y += h + 12;
    });

    // Tasmee
    y += 35;
    ctx.fillStyle = accentColor;
    ctx.font = "900 66px Cairo";
    ctx.fillText("Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ³Ù…ÙŠØ¹:", centerX, y);
    y += 90;

    ctx.fillStyle = bodyColor;
    ctx.font = "800 50px Cairo";
    data.tasmee.lines.slice(0,2).forEach((ln)=>{
      const h = drawWrapped(ctx, ln, centerX, y, 1750, 78, "center");
      y += h + 10;
    });

    // Conditions
    y += 35;
    ctx.fillStyle = accentColor;
    ctx.font = "900 66px Cairo";
    ctx.fillText("Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:", centerX, y);
    y += 90;

    ctx.fillStyle = bodyColor;
    ctx.font = "800 48px Cairo";
    data.conds.slice(0,6).forEach((c)=>{
      const h = drawWrapped(ctx, "âœ… " + c, centerX, y, 1750, 74, "center");
      y += h + 8;
    });

    // Deadline
    y += 35;
    ctx.fillStyle = bodyColor;
    ctx.font = "900 58px Cairo";
    ctx.fillText(`â³ Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªØ³Ù„ÙŠÙ…: ${data.deadline}`, centerX, y);
    y += 95;

    // Note
    if(data.note){
      ctx.fillStyle = bodyColor;
      ctx.font = "800 46px Cairo";
      const h = drawWrapped(ctx, data.note, centerX, y, 1750, 70, "center");
      y += h + 55;
    }

    // Closing
    ctx.fillStyle = accentColor;
    ctx.font = "900 58px Cairo";
    drawWrapped(ctx, `â­ ${data.closing} â­`, centerX, y, 1750, 76, "center");

    setStatus(usedFallback ? "ØªÙ… (Ù‚Ø§Ù„Ø¨ Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©)" : "ØªÙ…");
  }

  // ====== Downloads ======
  function downloadCanvasPNG(){
    try{
      const dataURL = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.download = "ramadan-competition-a4.png";
      a.href = dataURL;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }catch(e){
      alert("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø¬Ø±Ù‘Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ (Ø®Ø§Ù†Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©) Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„.");
      console.error(e);
    }
  }

  function downloadCanvasPDF(){
    try{
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4", compress: true });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const imgData = canvas.toDataURL("image/jpeg", 0.95);
      pdf.addImage(imgData, "JPEG", 0, 0, pageW, pageH);
      pdf.save("ramadan-competition-a4.pdf");
    }catch(e){
      alert("ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± PDF. Ø¬Ø±Ù‘Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±.");
      console.error(e);
    }
  }

  // ====== Tests (lightweight) ======
  function runTests(){
    try{
      console.assert(DEFAULT_TRACKS.length === 4, "DEFAULT_TRACKS should have 4");
      console.assert(TRACK_OPTIONS.includes("Ø¬Ø²Ø¡ Ø¹Ù…"), "TRACK_OPTIONS should include Ø¬Ø²Ø¡ Ø¹Ù…");
      console.assert(TRACK_OPTIONS.includes("Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ"), "TRACK_OPTIONS should include Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ");

      // Contest length clamp
      const s = "Ø§".repeat(80);
      console.assert(clampText(s,60).length <= 60, "clampText should limit to 60");

      // WrapText should return at least 1 line
      ctx.font = "700 46px Cairo";
      console.assert(wrapText(ctx, "Ù†Øµ ØªØ¬Ø±ÙŠØ¨ÙŠ", 200).length >= 1, "wrapText should return lines");

      console.log("âœ… Tests passed");
    }catch(e){
      console.warn("Tests warning", e);
    }
  }

  // ====== Events ======
  function wire(){
    // Default conditions
    condsEl.innerHTML = "";
    DEFAULT_CONDS.forEach(c=> condsEl.appendChild(createCondInput(c)));

    addCondBtn.addEventListener("click", ()=>{
      condsEl.appendChild(createCondInput(""));
      render();
    });

    // Upload background to avoid CORS
    bgFile.addEventListener("change", ()=>{
      const file = bgFile.files && bgFile.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => { bgDataUrl = String(reader.result || ""); render(); };
      reader.readAsDataURL(file);
    });

    // Auto render
    document.querySelectorAll("input,textarea,select").forEach(el=> el.addEventListener("input", ()=> render()));

    tasmeeType.addEventListener("change", ()=>{
      if(tasmeeType.value === "default"){
        tasmeeDefault.style.display = "block";
        tasmeeOther.style.display = "none";
      }else{
        tasmeeDefault.style.display = "none";
        tasmeeOther.style.display = "block";
      }
      render();
    });

    renderBtn.addEventListener("click", render);
    downloadPng.addEventListener("click", downloadCanvasPNG);
    downloadPdf.addEventListener("click", downloadCanvasPDF);
  }

  // Boot
  initTracks();
  wire();
  runTests();
  render();
</script>

</body>
</html>
